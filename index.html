<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Poll (GitHub Pages + Supabase)</title>

  <!-- Libraries (deferred) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.4.4/qrcode.min.js" defer></script>

  <style>
    :root{
      --bg:#f7fafc; /* light */
      --bg-grad:linear-gradient(180deg,#ffffff 0%,#f7fafc 100%);
      --card:#ffffff;
      --text:#0f172a; /* slate-900 */
      --muted:#475569; /* slate-600 */
      --accent:#2563eb; /* blue-600 */
      --accent-2:#7c3aed; /* violet-600 */
      --border:#e2e8f0; /* slate-200 */
      --ok:#16a34a; /* green-600 */
      --danger:#dc2626; /* red-600 */
      --chip:#eef2ff; /* indigo-50 */
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;background:var(--bg-grad);color:var(--text)}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:22px;box-shadow:0 8px 24px rgba(2,6,23,.06)}
    .row{display:grid;gap:20px}
    @media(min-width:880px){.row{grid-template-columns:1fr 300px;align-items:start}}
    .row.single{grid-template-columns:1fr !important}
    h1{margin:0 0 10px;font-size:26px}
    p.sub{margin:0 0 16px;color:var(--muted)}
    label{display:block;margin:10px 0 6px;color:var(--muted)}
    input,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--text)}
    input[type=number]{max-width:180px}
    button{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:var(--accent);color:#fff;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,.05)}
    button.secondary{background:#fff;color:var(--text)}
    button.ghost{background:transparent;border-color:var(--border);color:var(--text)}
    button:hover{filter:brightness(1.04)}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .options{display:grid;gap:10px}
    .ok{color:var(--ok);margin-top:10px;display:none}
    canvas{width:100%;height:380px}
    .qrbox{display:flex;flex-direction:column;gap:8px;align-items:center;padding:14px;background:#fff;border:1px dashed var(--border);border-radius:14px}
    .qrbox a{display:block;max-width:100%;word-break:break-all;overflow-wrap:anywhere;text-align:center}
    .muted{color:var(--muted)}
    .hdr{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .badge{background:var(--chip);color:#3730a3;border:1px solid #e0e7ff;border-radius:999px;padding:4px 10px;font-size:12px}
    nav a{opacity:.9;padding:6px 10px;border-radius:10px}
    nav a.active{background:#e0e7ff;color:#3730a3}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .note{font-size:12px;color:var(--muted);margin-top:8px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;font-size:12px;background:#fff}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">ðŸ“Š Live Poll <span class="badge">Bright UI</span></div>
      <nav style="display:flex;gap:10px;margin-left:auto">
        <a href="#/create" id="link-create">Create</a>
        <a href="#/help" id="link-help">Help</a>
      </nav>
    </div>

    <div id="view" class="card">Loadingâ€¦</div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ---------- 1) Supabase (SET THESE) ----------
      const SUPABASE_URL = 'https://phfouqkgbvnrnrakjjxo.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBoZm91cWtnYnZucm5yYWtqanhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyNTk2ODYsImV4cCI6MjA3MTgzNTY4Nn0.dIQuRUhATXxA083HCmWydoFmH6ip5uCQq9kq0yJhwxw';
      const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: { persistSession: false, autoRefreshToken: false, storageKey: 'polling_no_session' }
      });

      // ---------- 2) Router ----------
      const el = sel => document.querySelector(sel);
      const view = el('#view');
      const routes = { '#/create': renderCreate, '#/admin': renderAdmin, '#/vote': renderVote, '#/help': renderHelp };
      function go() {
        const parts = location.hash.split('/');
        const hash = parts.slice(0,2).join('/');
        const id = parts[2];
        const route = routes[hash] || renderHome;
        route(id);
		// Hide the top nav on the vote page
		const nav = document.querySelector('nav');
		if (nav) {
			if (hash === '#/vote') nav.classList.add('hidden');
			else nav.classList.remove('hidden');
		}
        document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
        const active = document.querySelector(`nav a[href='${hash}']`);
        if (active) active.classList.add('active');
      }
      window.addEventListener('hashchange', go);

      // ---------- 3) Views ----------
      function renderHome() {
        view.innerHTML = `
          <h1>Create your first poll</h1>
          <p class="sub">Host on <strong>GitHub Pages</strong>, store data in <strong>Supabase</strong>, and see <strong>live results</strong>.
          Start at <a href="#/create">Create</a> or check <a href="#/help">Help</a>.</p>
        `;
      }

      function renderHelp() {
        view.innerHTML = `
          <h1>Help</h1>
          <ol>
            <li>Put your <span class="mono">Project URL</span> and <span class="mono">anon key</span> at the top of this file.</li>
            <li>Run the schema below, and enable Realtime on <span class="mono">public.votes</span>.</li>
            <li>Use <span class="mono">#/create</span> to make a poll.</li>
          </ol>
          <details>
            <summary>Database schema (run in Supabase SQL editor)</summary>
<pre class="mono" style="white-space:pre-wrap">-- Core tables
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

CREATE TABLE IF NOT EXISTS public.polls (
  id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  question text NOT NULL,
  options jsonb NOT NULL CHECK (jsonb_typeof(options) = 'array'),
  allow_multi_select boolean NOT NULL DEFAULT true,
  max_selections int NULL,
  live_results boolean NOT NULL DEFAULT true,
  poll_refresh_ms int NOT NULL DEFAULT 0,
  show_qr boolean NOT NULL DEFAULT false,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

CREATE TABLE IF NOT EXISTS public.votes (
  id bigserial PRIMARY KEY,
  poll_id uuid NOT NULL REFERENCES public.polls(id) ON DELETE CASCADE,
  option_index int NOT NULL CHECK (option_index >= 0),
  created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS votes_poll_option_idx ON public.votes(poll_id, option_index);

ALTER TABLE public.polls ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.votes ENABLE ROW LEVEL SECURITY;

DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE policyname = 'Public read polls') THEN
    CREATE POLICY "Public read polls"  ON public.polls FOR SELECT USING (true);
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE policyname = 'Public create polls') THEN
    CREATE POLICY "Public create polls" ON public.polls FOR INSERT WITH CHECK (true);
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE policyname = 'Public update polls') THEN
    CREATE POLICY "Public update polls" ON public.polls FOR UPDATE USING (true) WITH CHECK (true);
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE policyname = 'Public read votes') THEN
    CREATE POLICY "Public read votes"   ON public.votes FOR SELECT USING (true);
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE policyname = 'Public create votes') THEN
    CREATE POLICY "Public create votes" ON public.votes FOR INSERT WITH CHECK (true);
  END IF;
END $$;

-- Realtime: enable schema 'public' and table 'votes'
</pre>
          </details>
          <p class="note">If live updates still don't appear, re-check Realtime is enabled and your poll row has <span class="mono">live_results=true</span>.</p>
        `;
      }

      async function renderCreate() {
        view.innerHTML = `
          <h1>Create a Poll</h1>
          <label>Question</label>
          <input id="q" placeholder="Your question" />
          <label>Options (comma separated)</label>
          <input id="opts" placeholder="Red, Green, Blue" />
          <div class="btnrow">
            <label class="switch"><input type="checkbox" id="multi" checked /> Allow multiple select</label>
            <label>Max selections (0 = unlimited) <input type="number" id="maxsel" min="0" value="0" /></label>
          </div>
          <div class="btnrow">
            <label class="switch"><input type="checkbox" id="live" checked /> Live results</label>
            <label>Polling ms (when live off) <input type="number" id="pollms" min="0" value="0" /></label>
            <label class="switch"><input type="checkbox" id="qrDefault" /> Show QR by default</label>
          </div>
          <div class="btnrow"><button id="btn">Create</button></div>
          <p id="msg" class="ok">Created!</p>
        `;
        const maxsel = el('#maxsel');
        el('#multi').addEventListener('change', () => { maxsel.disabled = !el('#multi').checked; });
        maxsel.disabled = !el('#multi').checked;

        el('#btn').addEventListener('click', async () => {
          const question = el('#q').value.trim();
          const options = el('#opts').value.split(',').map(s => s.trim()).filter(Boolean);
          if (!question || options.length < 2) return alert('Please provide a question and at least 2 options.');
          el('#btn').disabled = true;
          const allow_multi_select = el('#multi').checked;
          const max_selections = Number(maxsel.value) || null;
          const live_results = el('#live').checked;
          const poll_refresh_ms = Number(el('#pollms').value) || 0;
          const show_qr = el('#qrDefault').checked;
          const { data, error } = await sb.from('polls').insert({
            question, options,
            allow_multi_select, max_selections,
            live_results, poll_refresh_ms,
            show_qr
          }).select('id').single();
          el('#btn').disabled = false;
          if (error) { console.error(error); return alert('Create failed: ' + error.message); }
          el('#msg').style.display = 'block';
          location.hash = `#/admin/${data.id}`;
        });
      }

      async function renderAdmin(id) {
        const pollId = id || location.hash.split('/')[2];
        if (!pollId) return view.innerHTML = '<p>Missing poll id.</p>';

        // Load poll
        let { data: poll, error } = await sb.from('polls').select('*').eq('id', pollId).single();
        if (error || !poll) return view.innerHTML = '<p>Poll not found.</p>';

        // Helpers to persist partial changes
        async function savePatch(patch){
          patch.updated_at = new Date().toISOString();
          const { error } = await sb.from('polls').update(patch).eq('id', pollId);
          if (error) console.error('Update failed:', error);
        }

        const voteUrl = `${location.origin}${location.pathname}#/vote/${pollId}`;
        const rowClass = poll.show_qr ? 'row' : 'row single';
        view.innerHTML = `
          <h1>${escapeHtml(poll.question)}</h1>
          <div class="controls">
            <span class="pill">${poll.live_results ? 'Live' : (poll.poll_refresh_ms>0 ? 'Polling' : 'Manual')}</span>
            <button class="secondary" id="btnToggleQR">${poll.show_qr ? 'Hide QR' : 'Show QR'}</button>
            <button class="secondary" id="btnToggleLive">${poll.live_results ? 'Disable live' : 'Enable live'}</button>
            <button class="ghost" id="btnCopyLink">Copy vote link</button>
          </div>
          <div class="${rowClass}" style="margin-top:12px">
            <div>
              <canvas id="chart"></canvas>
              <div class="note">
                Voting link: <a href="${voteUrl}" target="_blank" class="mono">${voteUrl}</a><br/>
                Live results: ${poll.live_results ? 'ON (Realtime)' : (poll.poll_refresh_ms ? 'Polling every ' + Math.round(poll.poll_refresh_ms/1000) + 's' : 'OFF')}
              </div>
            </div>
            <div id="qrWrap" class="qrbox ${poll.show_qr ? '' : 'hidden'}">
              <canvas id="qr" width="220" height="220"></canvas>
              <small>Scan the above QR to vote</small>
            </div>
          </div>
        `;

        // QR render (on demand)
        function ensureQR(){
          const wrap = el('#qrWrap');
          if (wrap && !wrap.classList.contains('hidden') && window.QRCode) {
            try { window.QRCode.toCanvas(el('#qr'), voteUrl, { margin: 1, width: 220 }); } catch(_){}
          }
        }
        ensureQR();

        // Chart
        const ctx = document.getElementById('chart').getContext('2d');
        const chart = new window.Chart(ctx, {
          type: 'bar',
          data: { labels: poll.options, datasets: [{ label: 'Votes', data: poll.options.map(_ => 0) }] },
          options: { scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }, plugins: { legend: { display:false } } }
        });

        // Totals + realtime/polling control
        async function refreshTotals(){
          const { data, error } = await sb.from('votes').select('option_index').eq('poll_id', pollId);
          if (error) { console.error('refreshTotals error:', error); return; }
          const counts = Array(poll.options.length).fill(0);
          (data||[]).forEach(r=>{ if(Number.isInteger(r.option_index) && r.option_index>=0 && r.option_index<counts.length) counts[r.option_index]++; });
          chart.data.datasets[0].data = counts; chart.update();
        }
        await refreshTotals();

        let channel = null, timer = null;
        function stopLive(){ if(channel){ sb.removeChannel(channel); channel=null; } if(timer){ clearInterval(timer); timer=null; } }
        function startLive(){
          stopLive();
          if(poll.live_results){
            channel = sb.channel('votes-'+pollId)
              .on('postgres_changes',{event:'INSERT',schema:'public',table:'votes',filter:`poll_id=eq.${pollId}`},refreshTotals)
              .subscribe();
          } else if (poll.poll_refresh_ms>0){
            timer=setInterval(refreshTotals, poll.poll_refresh_ms);
          }
        }
        startLive();

        // Buttons (robust class toggles)
        el('#btnToggleQR')?.addEventListener('click', async () => {
          poll.show_qr = !poll.show_qr;
          const wrap = el('#qrWrap');
          if (poll.show_qr) { wrap.classList.remove('hidden'); ensureQR(); }
          else { wrap.classList.add('hidden'); }
          el('#btnToggleQR').textContent = poll.show_qr ? 'Hide QR' : 'Show QR';
          await savePatch({ show_qr: poll.show_qr });
        });

        el('#btnToggleLive')?.addEventListener('click', async () => {
          poll.live_results = !poll.live_results;
          el('#btnToggleLive').textContent = poll.live_results ? 'Disable live' : 'Enable live';
          await savePatch({ live_results: poll.live_results });
          startLive();
        });

        el('#btnCopyLink')?.addEventListener('click', async () => {
          try { await navigator.clipboard.writeText(voteUrl); el('#btnCopyLink').textContent = 'Copied!'; setTimeout(()=> el('#btnCopyLink').textContent = 'Copy vote link', 1200); } catch(_){}
        });
      }

      async function renderVote(id) {
        const pollId = id || location.hash.split('/')[2];
        if (!pollId) return view.innerHTML = '<p>Missing poll id.</p>';
        const { data: poll, error } = await sb.from('polls').select('*').eq('id', pollId).single();
        if (error || !poll) return view.innerHTML = '<p>Poll not found.</p>';

        if (poll.allow_multi_select) {
          // Multi-select UI
          view.innerHTML = `
            <h1>${escapeHtml(poll.question)}</h1>
            <p class="sub">You may select multiple options${poll.max_selections ? ` (up to ${poll.max_selections}).` : '.'}</p>
            <div id="ops" class="options"></div>
            <div class="btnrow"><button id="submitBtn">Submit vote</button></div>
            <p class="ok" id="ok">âœ… Thanks â€” your votes were recorded.</p>
          `;
          const ops = el('#ops');
          poll.options.forEach((opt, i) => {
            const label = document.createElement('label');
            label.style.display = 'flex'; label.style.gap = '10px'; label.style.alignItems = 'center';
            const cb = document.createElement('input'); cb.type = 'checkbox'; cb.className = 'opt'; cb.dataset.idx = String(i);
            label.appendChild(cb); const span = document.createElement('span'); span.textContent = opt; label.appendChild(span);
            ops.appendChild(label);
          });
          function enforceLimit(){
            if (!poll.max_selections || poll.max_selections<=0) return;
            const boxes = Array.from(document.querySelectorAll('.opt'));
            const selected = boxes.filter(b=>b.checked);
            boxes.forEach(b=>{ b.disabled = !b.checked && selected.length >= poll.max_selections; });
          }
          ops.addEventListener('change', enforceLimit);
          el('#submitBtn').addEventListener('click', async () => {
            const chosen = Array.from(document.querySelectorAll('.opt')).filter(x=>x.checked).map(x=>Number(x.dataset.idx));
            if (chosen.length===0) return alert('Please select at least one option.');
            if (poll.max_selections && chosen.length>poll.max_selections) return alert(`Please select up to ${poll.max_selections}.`);
            el('#submitBtn').disabled = true;
            const payload = chosen.map(idx => ({ poll_id: pollId, option_index: idx }));
            const { error } = await sb.from('votes').insert(payload);
            if (error) { console.error(error); alert('Vote failed: ' + error.message); el('#submitBtn').disabled = false; return; }
            el('#ok').style.display = 'block'; document.querySelectorAll('.opt').forEach(x=>x.disabled=true);
          });
        } else {
          // Single-select UI
          view.innerHTML = `
            <h1>${escapeHtml(poll.question)}</h1>
            <div class="options" id="ops"></div>
            <p class="ok" id="ok">âœ… Thanks â€” your vote was recorded.</p>
          `;
          const ops = el('#ops');
          poll.options.forEach((opt, i) => {
            const b = document.createElement('button'); b.textContent = opt; b.className='secondary';
            b.addEventListener('click', async () => {
              b.disabled = true; Array.from(ops.children).forEach(x=>x.disabled=true);
              const { error } = await sb.from('votes').insert({ poll_id: pollId, option_index: i });
              if (error) { console.error(error); alert('Vote failed: ' + error.message); b.disabled=false; return; }
              el('#ok').style.display = 'block';
            });
            ops.appendChild(b);
          });
        }
      }

      // ---------- 4) Utils ----------
      function escapeHtml(s=''){return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]))}

      // Boot the router
      go();
    });
  </script>
</body>
</html>